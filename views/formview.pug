extends formviewlayout.pug

block body
    #main.w3-main(style='margin-left:250px')
        .w3-row.w3-padding-32
            .w3-container2.w3-card.w3-white.w3-round.w3-margin
                .w3-row
                    h1.w3-center Form Name: #{currentForm.form_name}

                .w3-row
                    .w3-twothird.w3-container2
                        h2 Form Details
                        hr
                        .w3-third
                            .w3-container2.w3-card.w3-white.w3-round.w3-margin
                                h2 Version History
                                .w3-row
                                    select#versionDropDown(name='versionDropDown')
                                        each version in allVersions
                                            option #{version.user_version}
                                .w3-row
                                    br
                                    button.w3-button.w3-block.w3-theme-dark(onclick=`dropDownUserFormVersion('${currentForm.form_control_number}')`)
                                        i.fa.fa-refresh.fa-fw.w3-margin-right
                                        |   Load Form
                        .w3-third
                            .w3-container2.w3-card.w3-white.w3-round.w3-margin
                                h2 Share Document
                                .w3-row
                                    input(id='employee_email' name='employee_email' placeholder="Employee Email")
                                .w3-row
                                    select#accessLevel(name='accessLevel')
                                        option(value='Viewer') Viewer
                                        option(value='Editor') Editor
                                .w3-row
                                    br
                                    button.w3-button.w3-block.w3-theme-dark(onclick='shareForm()')
                                        i.fa.fa-share-alt.fa-fw.w3-margin-right
                                        |   Share

                        .w3-third
                            .w3-container2.w3-card.w3-white.w3-round.w3-margin
                                h2 Shared with
                                h4
                                    i.fa.fa-eye.fa-fw.w3-margin-right
                                    |   denmark - View Only
                                h4
                                    i.fa.fa-eye.fa-fw.w3-margin-right
                                    |   jao - View Only
                                h4
                                    i.fa.fa-eye.fa-fw.w3-margin-right
                                    i.fa.fa-pencil-square-o.fa-fw.w3-margin-right
                                    |   jian - View and Edit

                    .w3-third.w3-container2
                        h2 Form Settings
                        hr
                        .w3-row
                            .w3-container2.w3-card.w3-white.w3-round.w3-margin
                                .w3-row
                                    button.w3-button.w3-block.w3-theme-dark(onclick='saveFilledOutForm()')
                                        i.fa.fa-floppy-o.fa-fw.w3-margin-right
                                        |   Save Form
                                    br
                                    button.w3-button.w3-block.w3-theme-dark(onclick='downloadAsPDF()')
                                        i.fa.fa-download.fa-fw.w3-margin-right
                                        |   Download as PDF


        .w3-row
            .w3-container2.w3-card.w3-white.w3-round.w3-margin
                #theContainerOfTheForm

        #deleteFileModal
            #deleteFileOverLay.dialogoverlay
            #deleteFileDialogbox.dialogbox.slit-in-vertical
                #randomDiv
                    .dialogboxhead
                        .i.fa.fa-exclamation-circle Confirm File Deletion
                    .dialogboxbody
                        p Are you sure you want to delete this file?
                        h2#selectedFileForDeletionPlaceholder
                .dialogboxfoot
                    button.pure-material-button-contained.active(onclick=`deleteSelectedFile()`) Yes
                .dialogboxfoot2
                    button.pure-material-button-contained.active(onclick=`hideDeleteModal()`) No



        .w3-row.w3-padding-32
            .w3-container2.w3-card.w3-white.w3-round.w3-margin
                .w3-row
                    h1 File Management
                    hr
                    .w3-twothird.w3-container
                        .w3-container2.w3-card.w3-white.w3-round.w3-margin

                            table#filesTable.display(width='100%')
                                thead
                                    tr
                                        th File Name
                                        th File Size
                                        th Uploaded By
                                        th Uploaded At
                                        th File Actions
                                tbody
                                    each file in currentUserFiles
                                        tr
                                            td #{file.file_name}
                                            td #{file.file_size}
                                            td #{file.uploadedBy}
                                            td #{file.uploadedAt}
                                            td
                                                a.w3-half.w3-hover-white.edit-btn(href='/downloadfile/'+file.file_name)
                                                    i.fa.fa-pencil.w3-text-theme
                                                a.w3-half.w3-hover-white(onclick=`showDeleteModal("${file.file_name}")`)
                                                    i.fa.fa-times.w3-text-theme


                    .w3-third.w3-container
                        .w3-container2.w3-card.w3-white.w3-round.w3-margin
                            h1
                                i.fa.fa-upload.w3-text-theme
                                |   Upload Files
                            hr
                            form(action="/", method="POST", enctype="multipart/form-data" id="upload-form")
                                .w3-row
                                    input.bottone5(type="file", name="file", id="file")
                                    br
                                    input.bottone5(type="submit", value="Upload")

    script(src='https://code.jquery.com/ui/1.13.2/jquery-ui.js')
    link(rel='stylesheet' href='//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css')

    script.
        function dropDownUserFormVersion(formControlNumber){
            var userVersionChoice = document.getElementById("versionDropDown").value;

            const data = {
                formControlNumber: formControlNumber,
                userVersionChoice: userVersionChoice
            };

            $.ajax({
                type: 'PUT',
                url: '/AJAX_formUserViewVersion',
                data: data,
                success: function(response) {
                    if (response.status_code === 0) {
                        // modal success
                        alert("Rendering the Chosen Version");
                        document.getElementById("theContainerOfTheForm").innerHTML = response.formContent;
                    } else if (response.status_code === 1){
                        // modal error
                        alert("Error in Viewing Chosen Version");
                    } else {
                        // modal error
                        alert("AJAX Error");
                    }
                },
                error: function(error){
                    console.error('AJAX Error: ', error);
                }
            });
        }

        function shareForm(){
            const shareTo = document.getElementById('employee_email').value;
            var formBlock = !{JSON.stringify(currentForm)};

            if(!shareTo){
                alert("Please enter an email to share the form to!");
            } else {
                const data = {
                    shareTo: shareTo,
                    formControlNumber: formBlock.form_control_number
                };

                $.ajax({
                    type: 'POST',
                    url: '/shareform',
                    data: data,
                    success: function(response) {
                        if (response.status_code === 1) {
                            alert("No user was selected to share the form.");
                        } else if (response.status_code === 0) {
                            alert("You shared the file to " + shareTo);
                        } else {
                            alert("AJAX error: ", error);
                        }
                    },
                    error: function(error) {
                        console.error('AJAX error:', error);
                    }
                });
            }
        }

    script.
        var formBlock = !{JSON.stringify(currentForm)};
        var empEmails = !{JSON.stringify(retrievedUserEmails)}
        var receivedFormContent = formBlock.form_content;
        console.log("This is the receivedFormContent ", receivedFormContent);
        var theContainerOfTheForm = document.getElementById('theContainerOfTheForm');
        theContainerOfTheForm.innerHTML = receivedFormContent;
        console.log(!{JSON.stringify(currentForm)});

        // STARTING PLAYGROUND OF JIAN



        $(function() {
            var allEmails = empEmails;
            $( "#employee_email" ).autocomplete({
                source: allEmails
            });
        });




    script(src='/js/client.functions/handle_ajax_save_filled_out_form.js')
