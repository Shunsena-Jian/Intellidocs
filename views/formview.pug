extends formviewlayout.pug

block body
    #main.w3-main(style='margin-left:250px')
        .w3-row.w3-padding-32
            .w3-container2.w3-card.w3-white.w3-round.w3-margin
                h1.w3-center Form Name: #{currentForm.form_name}
                button(onclick='saveFilledOutForm()') Save Form

        .w3-row
            .w3-half
                .w3-row
                    .w3-container2.w3-card.w3-white.w3-round.w3-margin
                        h2 Share Document
                        .w3-row
                            .w3-half
                                input(id='employee_email' name='employee_email' placeholder="Employee Email")
                            .w3-half
                                select#accessLevel(name='accessLevel')
                                    option(value='Viewer') Viewer
                                    option(value='Editor') Editor
                        button(onclick='shareForm()') Share

            .w3-half
                .w3-row
                    .w3-container2.w3-card.w3-white.w3-round.w3-margin
                        h2 Shared with
                        h4 denmark - View Only
                        h4 jao - View Only
                        h4 jian - View and Edit

        .w3-row
            .w3-container2.w3-card.w3-white.w3-round.w3-margin
                //#form-content.pages
                #theContainerOfTheForm

        .w3-row.w3-padding-64
            .w3-twothird.w3-container
                .w3-container2.w3-card.w3-white.w3-round.w3-margin
                    h1 Files
                    hr
                    table#filesTable.display(width='100%')
                        thead
                            tr
                                th File Name
                                th File Size
                                th Uploaded By
                                th Uploaded At
                                th File Actions
                        tbody
                            each file in currentUserFiles
                                tr
                                    td #{file.file_name}
                                    td #{file.file_size}
                                    td #{file.uploadedBy}
                                    td #{file.uploadedAt}
                                    td
                                        a.w3-half.w3-hover-white.edit-btn(href='/downloadfile/'+file.file_name)
                                            i.fa.fa-pencil.w3-text-theme
                                        a.w3-half.w3-hover-white(onclick=`showDeleteModal("${file.file_name}")`)
                                            i.fa.fa-times.w3-text-theme
                    #id01.w3-modal
                        .w3-modal-content
                            .w3-container
                                span.w3-button.w3-display-topright(onclick="document.getElementById('id01').style.display='none'") &times;
                                p Are you sure you want to delete this file?
                                p#selectedFileForDeletionPlaceholder
                                a(onclick=`deleteSelectedFile()`) Yes
                                a(onclick="closeModal()") No

            .w3-quarter.w3-container
                .w3-container2.w3-card.w3-white.w3-round.w3-margin
                    h1 Upload Files
                    hr
                    form(action="/", method="POST", enctype="multipart/form-data" id="upload-form")
                        input.bottone5(type="file", name="file", id="file")
                        input.bottone5(type="submit", value="Upload")

    script(src='https://code.jquery.com/ui/1.13.2/jquery-ui.js')
    link(rel='stylesheet' href='//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css')

    script.
        function shareForm(){
            const shareTo = document.getElementById('employee_email').value;
            var formBlock = !{JSON.stringify(currentForm)};

            if(!shareTo){
                alert("Please enter an email to share the form to!");
            } else {
                const data = {
                    shareTo: shareTo,
                    formControlNumber: formBlock.form_control_number
                };

                $.ajax({
                    type: 'POST',
                    url: '/shareform',
                    data: data,
                    success: function(response) {
                        if (response.status_code === 1) {
                            alert("No user was selected to share the form.");
                        } else if (response.status_code === 0) {
                            alert("You shared the file to " + shareTo);
                        } else {
                            alert("AJAX error: ", error);
                        }
                    },
                    error: function(error) {
                        console.error('AJAX error:', error);
                    }
                });
            }
        }

    script.
        var formBlock = !{JSON.stringify(currentForm)};
        var empEmails = !{JSON.stringify(retrievedUserEmails)}
        var receivedFormContent = formBlock.form_content;
        console.log("This is the receivedFormContent ", receivedFormContent);
        var theContainerOfTheForm = document.getElementById('theContainerOfTheForm');
        theContainerOfTheForm.innerHTML = receivedFormContent;
        console.log(!{JSON.stringify(currentForm)});

        // STARTING PLAYGROUND OF JIAN



        $(function() {
            var allEmails = empEmails;
            $( "#employee_email" ).autocomplete({
                source: allEmails
            });
        });

        /*
        document.addEventListener("DOMContentLoaded", function(){

            const data = {
                formName: formBlock.form_name,
                formControlNumber: formBlock.form_control_number,
                formContent: receivedFormContent,
                formVersion: formBlock.form_version,
                formStatus: "On-going",
                formDateCreation: formBlock.date_created
            };

            $.ajax({
                type: 'POST',
                url:'/formautosave',
                data: data,
                success: function(response) {
                    if (response.status_code === 0){
                        alert("Form auto-saved.");
                    } else {
                        alert("AJAX function error.");
                    }
                },
                error: function(error){
                    console.log('AJAX Error: ' + error);
                    alert("AJAX function error!");
                }
            });
        });
        */

        // ENDING PLAYGROUND OF JIAN


    script(src='/js/client.functions/handle_ajax_save_filled_out_form.js')
